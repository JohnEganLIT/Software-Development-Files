<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>
    </style>
    <script type="text/javascript">  
      function draw(geo_data) {
	  //Defines that JavaScript code should be executed in "strict mode".
        "use strict";
		//Declare static varaiables for SVG
        var margin = 75,
            width = 1400 - margin,
            height = 600 - margin;

		//Standard D3 code to create SVG element with class of map
        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g')
            .attr('class', 'map');
			
		//get projection function for mercator
		var merc_projection = d3.geo.mercator()
									.scale(150)//zoom 
									.translate([width/1.5,height/1.25]);//centre
		//https://github.com/d3/d3-geo#paths
		//Creates a new geographic path generator with the default settings. 
		//sets the current projectiona of multidimensional array of positions forming multiple polygons
		var path = d3.geo.path().projection(merc_projection);
		
		
		//The path variaable is a function that gets passed the data
		//that is bound to each element in the selection 
		var map = svg.selectAll('path')//no path elements first time round
						.data(geo_data.features)//get the path values from features
						.enter()//standard D3 enter function
						.append('path')//add new path elements
						.attr('d',path)//set attributes of path elements
						.style('fill', 'SkyBlue')//https://www.w3schools.com/colors/colors_names.asp
						.style('stroke','black')
						.style('stroke-width', 0.5);
			
		function plot_world_cups(data){
		debugger;
		//https://github.com/d3/d3-collection#nests && http://bl.ocks.org/phoebebright/raw/3176159/
				var aggregated_data = d3.nest()
									//grouping to subset the data
										.key(function(d){
											//group all worldcup matches by year
											return d['date'].getUTCFullYear();
										debugger;
										})
									//function to get summary statistics (attendance + location) from subset	
										.rollup(function(leaves){
											//sum up attendances
											var total = d3.sum(leaves, function(d) {
												return d['attendance'];
												});
												
										// convert each lat and long into pixel values
										var pixel_coords = d3.sum(leaves, function(d) {
											return merc_projection([+d.long, +d.lat]);
												});
												
										// get average lat pixel value
										var avg_x = d3.mean(pixel_coords, function(d) {
											return d[0];
												});
												
										// get average long pixel value
										var avg_y = d3.mean(pixel_coords, function(d) {
											return d[1];
												});
												
										return {//return values for the rollup function
												//aggregates for avg pixel location and total attendance
												'attendance' : total,
												'x' : 	avg_x,
												'y' : 	avg_y
												};
										})
										//pass all data through functions
										.entries(data);
										
										debugger;
		}
		
	  
	  // code to load and transfrom data discussed in D3 in depth
        d3.tsv("world_cup_geo.tsv", function(d) {
          d['attendance'] = +d['attendance'];
          d['date'] = format.parse(d['date']);
          return d;
        }, plot_world_cups);
      };
	  </script>
  </head>
<body>
  <script type="text/javascript">
  /*
    Use D3 to load the GeoJSON file
    */
    
d3.json("world_countries.json", draw);
  </script>
</body>
</html>
